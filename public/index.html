<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>XSWARM</title>

<style>
:root {
    --bg: #07090f;
    --panel: #0e1324;
    --border: #2a2f45;
    --text: #cfd7ff;
    --muted: #6b6f9c;
    --accent: #7aa2ff;
    --glow: #3a5cff;
}

* {
    box-sizing: border-box;
    font-family: Verdana, Tahoma, monospace;
}

body {
    margin: 0;
    background: radial-gradient(circle at top, #0d1230, #05070d 70%);
    color: var(--text);
    overflow-x: hidden;
}

/* CRT scanlines */
body::before {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.025),
        rgba(255,255,255,0.025) 1px,
        transparent 1px,
        transparent 3px
    );
    mix-blend-mode: overlay;
    animation: flicker 6s infinite;
}

/* vignette */
body::after {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    background: radial-gradient(circle, transparent 60%, rgba(0,0,0,.75));
}

@keyframes flicker {
    0%,100% { opacity: .85; }
    50% { opacity: 1; }
}

/* ---------- HEADER ---------- */
header {
    background: linear-gradient(#12183d, #07090f);
    border-bottom: 2px solid var(--border);
    padding: 14px;
    box-shadow: 0 0 30px #000;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

header h1 {
    margin: 0;
    font-size: 26px;
    letter-spacing: 4px;
    color: var(--accent);
    text-shadow:
        0 0 5px var(--glow),
        0 0 15px rgba(58,92,255,.8);
    cursor: pointer;
}

#userStatus {
    font-size: 11px;
    color: var(--muted);
}

/* ---------- PANELS ---------- */
.panel {
    background: linear-gradient(#12173a, #0b0e1e);
    border: 1px solid var(--border);
    box-shadow:
        inset 0 0 20px rgba(122,162,255,.08),
        0 0 25px rgba(58,92,255,.15);
    margin: 14px;
    padding: 12px;
}

/* ---------- INPUTS ---------- */
input, textarea, button {
    width: 100%;
    margin-top: 6px;
    padding: 6px;
    background: #07090f;
    color: var(--text);
    border: 1px solid var(--border);
}

input:focus, textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 10px var(--glow);
}

button {
    cursor: pointer;
    transition: all .2s;
}

button:hover {
    background: #12183d;
    box-shadow: 0 0 12px var(--glow);
}

/* ---------- POSTS ---------- */
.post {
    display: flex;
    flex-direction: row;
    margin: 14px;
    background: linear-gradient(#10163a, #0b0e1e);
    border: 1px solid var(--border);
    box-shadow:
        inset 0 0 18px rgba(122,162,255,.07),
        0 0 18px rgba(58,92,255,.18);
    animation: glowpulse 6s infinite alternate;
    border-radius: 6px;
}

@keyframes glowpulse {
    from { box-shadow: 0 0 12px rgba(58,92,255,.15); }
    to { box-shadow: 0 0 26px rgba(58,92,255,.35); }
}

.pfp {
    width: 48px;
    height: 48px;
    margin: 10px;
    border-radius: 4px;
    border: 1px solid var(--border);
    box-shadow: 0 0 10px rgba(58,92,255,.6);
}

.postContent {
    padding: 10px;
    flex: 1;
}

.title {
    color: var(--accent);
    font-size: 15px;
    text-shadow: 0 0 6px var(--glow);
}

.meta {
    font-size: 11px;
    color: var(--muted);
}

.actions button {
    width: auto;
    margin-right: 6px;
}

/* ---------- COMMENTS ---------- */
.comment {
    margin-top: 6px;
    margin-left: 24px;
    padding-left: 8px;
    border-left: 1px solid var(--border);
    font-size: 12px;
}

/* ---------- POST FLAIR / COMMUNITY ---------- */
.community {
    display: inline-block;
    background: #0b0e1e;
    border: 1px solid var(--border);
    padding: 1px 5px;
    margin-left: 6px;
    font-size: 10px;
    color: var(--accent);
    border-radius: 4px;
}

/* ---------- FOOTER GLOW ---------- */
footer {
    text-align: center;
    font-size: 10px;
    color: var(--muted);
    padding: 10px;
    text-shadow: 0 0 8px rgba(58,92,255,.5);
}
</style>
</head>

<body>

<header>
    <h1 onclick="window.scrollTo(0,0)">XSWARM</h1>
    <div id="userStatus">connecting…</div>
</header>

<!-- ---------- AUTH PANEL ---------- -->
<div id="auth" class="panel">
    <h3>Access Node</h3>
    <input id="username" placeholder="username">
    <input id="password" type="password" placeholder="password">
    <input id="pfp" placeholder="profile picture URL">
    <button onclick="signup()">Register</button>
    <button onclick="login()">Login</button>
</div>

<!-- ---------- POST CREATION PANEL ---------- -->
<div id="postBox" class="panel" style="display:none;">
    <h3>Create Transmission</h3>
    <input id="postTitle" placeholder="title">
    <input id="postCommunity" placeholder="community / flair">
    <textarea id="postBody" placeholder="content"></textarea>
    <button onclick="createPost()">Transmit</button>
</div>

<!-- ---------- FEED ---------- -->
<div id="feed"></div>

<footer>
    XSWARM // cached forever // no algorithms
</footer>
<script>
let currentUser = null;

// ---------- AUTH FUNCTIONS ----------
async function signup() {
    const res = await fetch("/api/signup", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            username: username.value,
            password: password.value,
            pfp: pfp.value
        })
    });
    if (res.ok) alert("Registered! Please log in.");
}

async function login() {
    const res = await fetch("/api/login", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            username: username.value,
            password: password.value
        })
    });
    if (res.ok) loadMe();
}

// ---------- LOAD CURRENT USER ----------
async function loadMe() {
    const res = await fetch("/api/me");
    currentUser = await res.json();

    if (currentUser) {
        auth.style.display = "none";
        postBox.style.display = "block";
        userStatus.innerHTML = `logged in as <b>${currentUser.username}</b>`;
    }
    loadPosts();
}

// ---------- CREATE POST ----------
async function createPost() {
    await fetch("/api/posts", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            title: postTitle.value,
            body: postBody.value,
            community: postCommunity.value
        })
    });
    postTitle.value = "";
    postBody.value = "";
    postCommunity.value = "";
    loadPosts();
}

// ---------- VOTING ----------
async function votePost(id, value) {
    await fetch("/api/vote", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ post_id: id, value })
    });
    loadPosts();
}

async function voteComment(id, value) {
    await fetch("/api/voteComment", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ comment_id: id, value })
    });
    loadPosts();
}

// ---------- ADD COMMENT ----------
async function addComment(postId, inputId) {
    const body = document.getElementById(inputId).value;
    if (!body) return;
    await fetch("/api/comments", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ post_id: postId, body })
    });
    loadPosts();
}

// ---------- MODERATOR ACTIONS ----------
async function deletePost(postId) {
    if (!confirm("Delete this post?")) return;
    await fetch("/api/mod/deletePost", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ post_id: postId })
    });
    loadPosts();
}

async function deleteComment(commentId) {
    if (!confirm("Delete this comment?")) return;
    await fetch("/api/mod/deleteComment", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ comment_id: commentId })
    });
    loadPosts();
}

async function deleteUser(username) {
    if (!confirm("Delete this user?")) return;
    await fetch("/api/mod/deleteUser", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ username })
    });
    loadPosts();
}

// ---------- LOAD POSTS ----------
async function loadPosts() {
    const res = await fetch("/api/posts");
    const posts = await res.json();
    feed.innerHTML = "";

    posts.forEach(p => {
        const postEl = document.createElement("div");
        postEl.className = "post";

        postEl.innerHTML = `
            <img class="pfp" src="${p.pfp || ''}">
            <div class="postContent">
                <div class="title">${p.title}<span class="community">${p.community || ''}</span></div>
                <div class="meta">by <a href="/u/${p.username}" class="profile-link">${p.username}</a></div>
                <div>${p.body}</div>
                <div class="actions">
                    <button onclick="votePost(${p.id},1)">▲</button>${p.score}<button onclick="votePost(${p.id},-1)">▼</button>
                    <button onclick="toggleComments(${p.id})">replies</button>
                    ${currentUser?.username==='mod'? `<button class="moderator-btn" onclick="deletePost(${p.id})">MOD DEL</button>` : ''}
                </div>
                <div id="comments-${p.id}"></div>
            </div>
        `;
        feed.appendChild(postEl);
    });
}

// ---------- TOGGLE COMMENTS ----------
async function toggleComments(postId) {
    const container = document.getElementById("comments-" + postId);
    if (container.innerHTML) { container.innerHTML=""; return; }

    const res = await fetch("/api/comments/" + postId);
    const comments = await res.json();

    container.innerHTML = comments.map(c => {
        return `
        <div class="comment">
            <img class="pfp" src="${c.pfp || ''}">
            <b>${c.username}</b>: ${c.body}
            <div class="actions">
                <button onclick="voteComment(${c.id},1)">▲</button>${c.score}<button onclick="voteComment(${c.id},-1)">▼</button>
                ${currentUser?.username==='mod'? `<button class="moderator-btn" onclick="deleteComment(${c.id})">MOD DEL</button>` : ''}
            </div>
            <input id="reply-${c.id}" placeholder="reply…">
            <button onclick="addComment(${postId},'reply-${c.id}')">send</button>
        </div>
        `;
    }).join('');
}

// ---------- INITIAL LOAD ----------
loadMe();
</script>
</body>
</html>
