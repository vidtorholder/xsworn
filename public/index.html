<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/png" href="x.png">
<meta charset="UTF-8">
<title>XSWARM</title>

<style>
:root {
    --bg: #07090f;
    --panel: #0e1324;
    --border: #2a2f45;
    --text: #cfd7ff;
    --muted: #6b6f9c;
    --accent: #7aa2ff;
    --glow: #3a5cff;
}

* {
    box-sizing: border-box;
    font-family: Verdana, Tahoma, monospace;
}

body {
    margin: 0;
    background: radial-gradient(circle at top, #0d1230, #05070d 70%);
    color: var(--text);
    overflow-x: hidden;
}

/* CRT scanlines */
body::before {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.025),
        rgba(255,255,255,0.025) 1px,
        transparent 1px,
        transparent 3px
    );
    mix-blend-mode: overlay;
    animation: flicker 6s infinite;
}

/* vignette */
body::after {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    background: radial-gradient(circle, transparent 60%, rgba(0,0,0,.75));
}

@keyframes flicker {
    0%,100% { opacity: .85; }
    50% { opacity: 1; }
}

/* ---------- HEADER ---------- */
header {
    background: linear-gradient(#12183d, #07090f);
    border-bottom: 2px solid var(--border);
    padding: 14px;
    box-shadow: 0 0 30px #000;
}

header h1 {
    margin: 0;
    font-size: 26px;
    letter-spacing: 4px;
    color: var(--accent);
    text-shadow:
        0 0 5px var(--glow),
        0 0 15px rgba(58,92,255,.8);
}

#userStatus {
    font-size: 11px;
    color: var(--muted);
}

/* ---------- PANELS ---------- */
.panel {
    background: linear-gradient(#12173a, #0b0e1e);
    border: 1px solid var(--border);
    box-shadow:
        inset 0 0 20px rgba(122,162,255,.08),
        0 0 25px rgba(58,92,255,.15);
    margin: 14px;
    padding: 12px;
}

/* ---------- INPUTS ---------- */
input, textarea, button {
    width: 100%;
    margin-top: 6px;
    padding: 6px;
    background: #07090f;
    color: var(--text);
    border: 1px solid var(--border);
}

input:focus, textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 10px var(--glow);
}

button {
    cursor: pointer;
    transition: all .2s;
}

button:hover {
    background: #12183d;
    box-shadow: 0 0 12px var(--glow);
}

/* ---------- POSTS ---------- */
.post {
    display: flex;
    margin: 14px;
    background: linear-gradient(#10163a, #0b0e1e);
    border: 1px solid var(--border);
    box-shadow:
        inset 0 0 18px rgba(122,162,255,.07),
        0 0 18px rgba(58,92,255,.18);
    animation: glowpulse 6s infinite alternate;
}

@keyframes glowpulse {
    from { box-shadow: 0 0 12px rgba(58,92,255,.15); }
    to { box-shadow: 0 0 26px rgba(58,92,255,.35); }
}

.pfp {
    width: 48px;
    height: 48px;
    margin: 10px;
    border-radius: 4px;
    border: 1px solid var(--border);
    box-shadow: 0 0 10px rgba(58,92,255,.6);
}

.postContent {
    padding: 10px;
    flex: 1;
}

.title {
    color: var(--accent);
    font-size: 15px;
    text-shadow: 0 0 6px var(--glow);
}

.meta {
    font-size: 11px;
    color: var(--muted);
}

.actions button {
    width: auto;
    margin-right: 6px;
}

/* ---------- COMMENTS ---------- */
.comment {
    margin-top: 6px;
    margin-left: 24px;
    padding-left: 8px;
    border-left: 1px solid var(--border);
    font-size: 12px;
}

/* ---------- FOOTER GLOW ---------- */
footer {
    text-align: center;
    font-size: 10px;
    color: var(--muted);
    padding: 10px;
    text-shadow: 0 0 8px rgba(58,92,255,.5);
}
</style>
</head>

<body>

<header>
    <h1>XSWARM</h1>
    <div id="userStatus">connecting…</div>
</header>

<!-- ---------- Auth Panel ---------- -->
<div id="auth" class="panel">
    <h3>Access Node</h3>
    <input id="username" placeholder="username">
    <input id="password" type="password" placeholder="password">
    <input id="pfp" placeholder="profile picture URL">
    <button onclick="signup()">Register</button>
    <button onclick="login()">Login</button>
</div>

<!-- ---------- Post Creation ---------- -->
<div id="postBox" class="panel" style="display:none;">
    <h3>Create Transmission</h3>
    <input id="postTitle" placeholder="title">
    <textarea id="postBody" placeholder="content"></textarea>
    <button onclick="createPost()">Transmit</button>
</div>

<!-- Moderator Notice -->
<div id="modNotice" class="panel" style="display:none; color: var(--accent);">
    You are logged in as MODERATOR
</div>

<!-- ---------- Feed ---------- -->
<div id="feed"></div>

<footer>
    XSWARM // cached forever // no algorithms
</footer>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let currentUser = null;
const feed = document.getElementById("feed");
const auth = document.getElementById("auth");
const postBox = document.getElementById("postBox");
const userStatus = document.getElementById("userStatus");
const modNotice = document.getElementById("modNotice");
// ------------------- Auth -------------------
async function signup() {
    const res = await fetch("/api/signup", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            username: username.value,
            password: password.value,
            pfp: pfp.value
        })
    });

    const data = await res.json();
    if (data.terminated) {
        alert("This account has been terminated and cannot be recreated.");
        return;
    }
    if (res.ok) alert("Registered. Log in.");
}

async function login() {
    const res = await fetch("/api/login", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            username: username.value,
            password: password.value
        })
    });

    const data = await res.json();

    if (data.terminated) {
        document.body.innerHTML = `
            <div style="padding:50px;text-align:center;">
                <h1>Account Terminated</h1>
                <p>We are very sorry but our moderators have decided your actions are not in regards of our terms of service, your account has been terminated.</p>
            </div>
        `;
        return;
    }

    if (res.ok) loadMe();
}

// ------------------- Load Current User -------------------
async function loadMe() {
    const res = await fetch("/api/me");
    currentUser = await res.json();

    if (currentUser) {
        auth.style.display = "none";
        postBox.style.display = "block";
        userStatus.innerHTML = `logged in as <b>${currentUser.username}</b>`;
        if (currentUser.isMod) modNotice.style.display = "block";
    }

    loadPosts();
}

// ------------------- Posts -------------------
async function createPost() {
    const title = postTitle.value;
    const body = postBody.value;
    if (!title && !body) return;

    await fetch("/api/posts", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ title, body })
    });

    postTitle.value = "";
    postBody.value = "";
}

async function vote(id, value) {
    await fetch("/api/vote", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ post_id: id, value })
    });
}

// ------------------- Comments -------------------
async function addComment(postId, inputId) {
    const input = document.getElementById(inputId);
    if (!input.value) return;

    await fetch("/api/comments", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ post_id: postId, body: input.value })
    });
    input.value = "";
}

async function toggleComments(id) {
    const box = document.getElementById("comments-" + id);
    if (box.innerHTML) { box.innerHTML = ""; return; }

    const res = await fetch("/api/comments/" + id);
    const comments = await res.json();

    box.innerHTML =
        comments.map(c => `
            <div class="comment">
                <img class="pfp" src="${c.pfp || ""}">
                <b>${c.username}</b>: ${c.body}
            </div>
        `).join("") +
        `<input id="reply-${id}" placeholder="reply…">
         <button onclick="addComment(${id},'reply-${id}')">send</button>`;
}

// ------------------- Render Post -------------------
function renderPost(p) {
    let el = document.getElementById("post-" + p.id);
    if (!el) {
        el = document.createElement("div");
        el.id = "post-" + p.id;
        el.className = "post";
        feed.prepend(el); // newest on top
    }

    el.innerHTML = `
        <img class="pfp" src="${p.pfp || ""}">
        <div class="postContent">
            <div class="title">${p.title}</div>
            <div class="meta">by ${p.username}</div>
            <div>${p.body}</div>
            <div class="actions">
                <button onclick="vote(${p.id},1)">▲</button>
                ${p.score || 0}
                <button onclick="vote(${p.id},-1)">▼</button>
                <button onclick="toggleComments(${p.id})">replies</button>
                ${currentUser?.isMod ? `<button onclick="terminateUser('${p.username}')">terminate user</button>` : ""}
            </div>
            <div id="comments-${p.id}"></div>
        </div>
    `;
}

// ------------------- Render Comment -------------------
function renderComment(c) {
    const box = document.getElementById("comments-" + c.post_id);
    if (!box) return;

    const div = document.createElement("div");
    div.className = "comment";
    div.innerHTML = `<img class="pfp" src="${c.pfp || ""}"><b>${c.username}</b>: ${c.body}`;
    box.appendChild(div);
}

// ------------------- Moderator: Terminate User -------------------
async function terminateUser(username) {
    if (!confirm(`Are you sure you want to terminate ${username}?`)) return;

    await fetch("/api/terminate/" + username, { method: "POST" });
    alert(`${username} has been terminated.`);
}

// ------------------- Socket.IO Events -------------------
socket.on("newPost", renderPost);
socket.on("updatePost", renderPost);
socket.on("newComment", renderComment);
socket.on("userTerminated", username => {
    // Remove posts by terminated user
    const posts = document.querySelectorAll(".post");
    posts.forEach(p => {
        if (p.querySelector(".meta").textContent.includes(username)) p.remove();
    });
});

// ------------------- Initial Load -------------------
async function loadPosts() {
    const res = await fetch("/api/posts");
    const posts = await res.json();
    feed.innerHTML = "";
    posts.reverse().forEach(renderPost);
}

loadMe();
</script>
</body>
</html>
